#######################################################################
# Test for copying block of size 4;
#######################################################################
	.pos 0
main:	irmovq Stack, %rsp  	# Set up stack pointer

	# Set up arguments for copy function and then invoke it
	irmovq $4, %rdx		# src and dst have 4 elements
	irmovq dest, %rsi	# dst array
	irmovq src, %rdi	# src array
	call ncopy		 
	halt			# should halt with num nonzeros in %rax
StartFun:
#/* $begin ncopy-ys */
##################################################################
# ncopy.ys - 8-way unrolled version for Y86 architecture
# Copy a src block of len words to dst.
# Return the number of positive words (>0) contained in src.
#
# Name: 徐文博
# ID: 1320240207
##################################################################

# %rdi = src, %rsi = dst, %rdx = len
ncopy:
##################################################################
# init
    xorq %rax, %rax          # global count = 0
    andq %rdx, %rdx
    jle Done

##################################################################
# 8-way loop
##################################################################
Loop8_Check:
    rrmovq %rdx, %rbx        # rbx = len
    iaddq $-8, %rbx          # rbx = len - 8
    jl Remain                # if len < 8 -> remainder

Loop8:
    # ---- load 8 values ----
    mrmovq  0(%rdi), %r10
    mrmovq  8(%rdi), %r11
    mrmovq 16(%rdi), %r12
    mrmovq 24(%rdi), %r13
    mrmovq 32(%rdi), %r14
    # Use temporaries for the last three loads to avoid clobbering
    # the pointers (%rdi,%rsi) and length (%rdx).
    # Note: simulator only provides registers up to %r14, so use %rbx
    # (which is safe to reuse here because Loop8_Check overwrites it
    # before each iteration) instead of %r15.
    mrmovq 40(%rdi), %rbx
    mrmovq 48(%rdi), %r8
    mrmovq 56(%rdi), %rcx

    # ---- store 8 ----
    rmmovq %r10,  0(%rsi)
    rmmovq %r11,  8(%rsi)
    rmmovq %r12, 16(%rsi)
    rmmovq %r13, 24(%rsi)
    rmmovq %r14, 32(%rsi)
    rmmovq %rbx, 40(%rsi)
    rmmovq %r8,  48(%rsi)
    rmmovq %rcx, 56(%rsi)

    # ---- local count (reduce rax dependency) ----
    # Use %r9 as local_count to avoid clobbering loaded values.
    xorq %r9, %r9          # local_count = 0

    andq %r10, %r10
    jle L0
    iaddq $1, %r9
L0:
    andq %r11, %r11
    jle L1
    iaddq $1, %r9
L1:
    andq %r12, %r12
    jle L2
    iaddq $1, %r9
L2:
    andq %r13, %r13
    jle L3
    iaddq $1, %r9
L3:
    andq %r14, %r14
    jle L4
    iaddq $1, %r9
L4:
    andq %rbx, %rbx
    jle L5
    iaddq $1, %r9
L5:
    andq %r8, %r8
    jle L6
    iaddq $1, %r9
L6:
    andq %rcx, %rcx
    jle L7
    iaddq $1, %r9
L7:

    # ---- merge local count ----
    addq %r9, %rax

    # ---- update pointers & len ----
    iaddq $64, %rdi          # src += 8 * 8
    iaddq $64, %rsi          # dst += 8 * 8
    iaddq $-8, %rdx          # len -= 8
    jmp Loop8_Check

##################################################################
# remainder loop (1-way)
##################################################################
Remain:
    andq %rdx, %rdx
    jle Done

Loop1:
    mrmovq 0(%rdi), %r10
    rmmovq %r10, 0(%rsi)

    andq %r10, %r10
    jle R0
    iaddq $1, %rax
R0:
    iaddq $8,  %rdi
    iaddq $8,  %rsi
    iaddq $-1, %rdx
    jg Loop1

##################################################################
Done:
    ret
##################################################################
End:
#/* $end ncopy-ys */
EndFun:

###############################
# Source and destination blocks 
###############################
	.align 8
src:
	.quad -1
	.quad 2
	.quad -3
	.quad 4
	.quad 0xbcdefa # This shouldn't get moved

	.align 16
Predest:
	.quad 0xbcdefa
dest:
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
Postdest:
	.quad 0xdefabc

.align 8
# Run time stack
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0

Stack:
